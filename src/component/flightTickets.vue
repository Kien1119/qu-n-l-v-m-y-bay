<!-- eslint-disable no-undef -->
<template>
  <div class="relative pb-20">
    <form action="">
      <div class="bg-slate-300 pt-5">
        <div class="flex h-14 rounded-lg bg-slate-50 justify-around border-2 my-3 mx-5 w-full">
          <img
            style="border-radius: 5px"
            src="https://www.vnas.vn/public/upload/files/29.9.2020/%E1%BA%A3nh%20vinayuuki%20vinh/04.10/06.10/10.10/%C4%91%E1%BA%A1i%20h%E1%BB%8Dc%20vinh/16.10/trang%20nh%C6%B0/ng%C3%A0y%2018.10/%C4%90%E1%BA%A1i%20h%20vinh/ng%C3%A0y%2030.10/th%C3%A1ng%2011/logo%2C/vietnam-airline-logo.jpg"
            alt=""
          />
          <span class="flex items-center text-orange-600 font-bold">
            {{ information?.bookingCode }}</span
          >
          <div class="flex items-center">
            <span class="text-stone-950 font-bold"
              >{{ formatDate(information?.departure?.time) }}-
            </span>
            {{ formatDate(information?.arrival?.time) }}
          </div>
          <span class="flex items-center font-bold text-amber-500">
            {{ information?.departure?.airport }} - {{ information?.arrival?.airport }}
          </span>
        </div>
        <div class="m-7 h-1/3 border-2 rounded-lg border-cyan-700 bg-slate-50 p-4">
          <div>
            <div class="border-2 rounded-lg">
              <div class="flex gap-3 bg-gradient-to-r from-cyan-500 from-10%">
                <div class="h-ful flex justify-center items-center bg-cyan-200">
                  <svg
                    data-v-532b2a7a=""
                    xmlns="http://www.w3.org/2000/svg"
                    width="50px"
                    height="30px"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-body feather feather-dollar-sign"
                  >
                    <line data-v-532b2a7a="" x1="12" y1="1" x2="12" y2="23"></line>
                    <path
                      class="w-50px"
                      data-v-532b2a7a=""
                      d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                    ></path>
                  </svg>
                </div>
                <div class="flex flex-col p-3">
                  <span class="font-bol text-2xl text-cyan-900"> Chi ti·∫øt gi√° </span>
                  <span>Th√¥ng tin gi√° v√©, ph√≠ d·ªãch v·ª• k√®m theo</span>
                </div>
              </div>
              <div class="card border-2 !border-gray-500 !rounded-lg mx-5 my-5">
                <DataTable :value="price" tableStyle="min-width: 50rem ">
                  <template #header>
                    <div class="flex flex-wrap items-center justify-center gap-2">
                      <span class="text-xl font-bold !text-orange-400"
                        >{{ getAirportName(information?.departure?.airport) }} ({{
                          information?.departure?.airport
                        }}) - {{ getAirportName(information?.arrival?.airport) }} ({{
                          information?.arrival?.airport
                        }})</span
                      >
                    </div>
                  </template>
                  <Column class="!rounded-lg" field="count" header="H√†nh kh√°ch"></Column>
                  <Column class="!rounded-lg" field="class" header="H·∫°ng"></Column>
                  <Column field="price" header="GI√Å"></Column>
                  <Column field="tax" header="Thu·∫ø"></Column>
                  <Column field="total" header="total"></Column>

                  <template #footer>
                    <span class="text-red-400 font-bold w-full flex flex-row-reverse"
                      >Gi√° chi ti·∫øt:
                      {{ formatPrice(price.reduce((acc, cur) => acc + cur.total, 0)) }}</span
                    >
                  </template>
                </DataTable>
              </div>
            </div>
          </div>
          <div class="flex flex-row-reverse items-center mt-5">
            <span class="text-gray-950 text-sm">(ƒê√£ bao g√¥m thu·∫ø, ph√≠)</span>
            <span class="text-orange-400 font-bold text-3xl">{{
              formatPrice(price.reduce((acc, cur) => acc + cur.total, 0))
            }}</span>
            <span class="text-slate-950 font-bold">T·ªïng chi ph√≠: </span>
          </div>
        </div>
        <div class="m-7 h-1/3 border-2 border-cyan-700 rounded-lg bg-slate-50 p-4">
          <div>
            <div class="border-2 rounded-lg">
              <div class="flex gap-3 bg-gradient-to-r from-cyan-500 from-10%">
                <div class="h-ful flex justify-center items-center bg-cyan-200">
                  <svg
                    data-v-33ccfcdd=""
                    xmlns="http://www.w3.org/2000/svg"
                    width="50px"
                    height="30px"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-body feather feather-users"
                  >
                    <path data-v-33ccfcdd="" d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle data-v-33ccfcdd="" cx="9" cy="7" r="4"></circle>
                    <path data-v-33ccfcdd="" d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path data-v-33ccfcdd="" d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                  </svg>
                </div>
                <div class="flex flex-col p-3">
                  <span class="font-bol text-2xl text-cyan-900">Th√¥ng tin h√†nh kh√°ch</span>
                  <span
                    >Nh·∫≠p ti·∫øng Vi·ªát kh√¥ng d·∫•u, t√™n h√†nh kh√°ch ph·∫£i ch√≠nh x√°c nh∆∞ trong CCCD/H·ªô
                    chi·∫øu/Gi·∫•y ph√©p l√°i xe.</span
                  >
                </div>
              </div>

              <div class="flex flex-col card border-2 !border-gray-500 rounded-lg mx-5 my-5 gap-5">
                <div class="flex flex-wrap items-center pl-4 gap-2"></div>
                <div class="bg-red-200 text-red-600 mx-4 font-bold rounded-lg p-3">
                  <span>
                    L∆∞u √Ω: "Theo y√™u c·∫ßu c·ªßa VietjetAir t·∫•t c·∫£ h√†nh kh√°ch ph·∫£i nh·∫≠p ng√†y sinh. Trong
                    tr∆∞·ªùng h·ª£p Qu√Ω AG ƒë·ªÉ tr·ªëng ch√∫ng t√¥i s·∫Ω cung c·∫•p d·ªØ li·ªáu ng·∫´u nhi√™n. BGT kh√¥ng
                    ch·ªãu tr√°ch nhi·ªám n·∫øu qu√Ω AG kh√¥ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin !"
                  </span>
                </div>
                <div
                  v-for="(item, index) in passengers"
                  :key="index"
                  class="card flex flex-col gap-4 px-4 bg-slate-200 p-6 m-4 rounded-lg py-4"
                >
                  <div class="h-7">
                    <span class="text-xl font-bold !text-gray-900 uppercase">
                      H√†nh Kh√°ch: {{ item.firstName }} {{ item.lastName }}{{ item.titleName }}
                    </span>
                  </div>

                  <div>
                    <div class="flex-1 flex flex-col gap-1">
                      <div>
                        <InputText
                          class="w-full uppercase"
                          v-bind="item.firstNameAttrs"
                          type="text"
                          v-model="item.firstName"
                          placeholder="H·ªç (*)"
                          :class="{ 'p-invalid': errors[`passengers.${item}.firstName`] }"
                        />
                      </div>
                      <span class="text-red-600">{{ errors?.passengers?.[index]?.firstName }}</span>

                      <div>
                        <Select
                          v-model="item.titleName"
                          v-bind="item.titleNameAttrs"
                          :options="title"
                          optionLabel="name"
                          optionValue="code"
                          placeholder="Danh x∆∞ng"
                          class="w-full"
                        />
                      </div>
                      <span class="text-red-600">{{ errors?.passengers?.[index]?.titleName }}</span>
                    </div>
                    <div class="flex-1 flex flex-col gap-1">
                      <div>
                        <InputText
                          v-bind="item.lastNameAttrs"
                          class="w-full uppercase"
                          v-model="item.lastName"
                          type="text"
                          placeholder="T√™n ƒë·ªám & T√™n (*)"
                          :class="{ 'p-invalid': errors[`passengers.${index}.lastName`] }"
                        />
                      </div>
                      <span class="text-red-600">{{ errors?.passengers?.[index]?.lastName }}</span>
                      <div>
                        <DatePicker
                          v-bind="item.birthdayAttrs"
                          v-model="item.birthday"
                          birthdayFormat="dd/mm/yy"
                          placeholder="Ng√†y sinh (DD-MM-YYYY)"
                          class="w-full"
                          :maxDate="new Date()"
                          :class="{ 'p-invalid': errors[`passengers.${index}.birthday`] }"
                        />
                      </div>
                      <span class="text-red-600">{{ errors?.passengers?.[index]?.birthday }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="p-7">
          <div class="flex flex-col p-4 border-2 border-cyan-700 rounded-lg bg-slate-50 gap-3">
            <div><span class="font-bold text-cyan-700">Th√¥ng tin li√™n h·ªá kh√°ch h√†ng</span></div>
            <div class="flex gap-5 bg-slate-300 p-4 rounded-lg">
              <div class="flex flex-col">
                <label for="phone">S·ªë ƒëi·ªán tho·∫°i: </label>
                <InputMask
                  v-bind="phoneAttrs"
                  id="phone"
                  v-model="phone"
                  mask="(84) 999-9999"
                  placeholder="(84) 999-9999"
                  :invalid="errors.phone"
                  fluid
                />
                <span class="h-6" style="color: #d81221">{{ errors.phone }}</span>
              </div>
              <div class="flex flex-col">
                <label for="email">Email: </label>
                <InputText
                  type="text"
                  v-bind="emailAttrs"
                  v-model="email"
                  placeholder="Vui l√≤ng nh·∫≠p"
                  :invalid="errors.email"
                />
                <span class="h-6" style="color: #d81221">{{ errors.email }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div
        class="backdrop-blur-md flex !bg-white/50 border gap-7 h-20 justify-center fixed inset-x-0 bottom-0"
      >
        <Button
          class="!bg-gradient-to-r from-orange-500 from-10% !rounded-2xl h-10 flex items-center shadow-2xl justify-center mt-5"
          label="Quay l·∫°i"
          @click="backBooking"
        ></Button>
        <Button
          class="!bg-gradient-to-r shadow-2xl from-orange-500 from-10% !rounded-2xl h-10 flex items-center justify-center mt-5"
          label="Gi·ªØ ch·ªó"
          @click="holdBooking"
        ></Button>
      </div>
    </form>
  </div>
</template>
<script setup lang="js">
import { onMounted, ref, watch } from 'vue'
import { usePlaneStore } from '@/stores/airports'
import { useReservationStore } from '@/stores/reservation'
import { useForm } from 'vee-validate'
import * as yup from 'yup'
import { useRouter } from 'vue-router'
import { useToast } from 'primevue/usetoast'
import { useConfirm } from 'primevue/useconfirm'

import { formatDate, formatPrice, genBookingCode } from '../utils/format'

const loading = ref(false)
const toast = useToast()

const router = useRouter()
const confirm = useConfirm()
const reservationStore = useReservationStore()
const planeStore = usePlaneStore()
const price = ref([{ count: 0 }])
const information = ref([])
const title = ref([
  { name: '√îng', code: 'MR' },
  { name: 'B√†', code: 'MRS' },
  { name: 'C√¥', code: 'MS' }
])
const passengers = ref([
  {
    firstName: '',
    lastName: '',
    titleName: '',
    birthday: '',
    firstNameAttrs: {},
    lastNameAttrs: {},
    titleNameAttrs: {},
    birthdayAttrs: {}
  }
])

watch(
  () => price.value[0]?.count,
  (newCount) => {
    if (newCount && newCount > 0) {
      passengers.value = Array.from({ length: newCount }, () => ({
        firstName: '',
        lastName: '',
        titleName: '',
        birthday: '',
        firstNameAttrs: {},
        lastNameAttrs: {},
        titleNameAttrs: {},
        birthdayAttrs: {}
      }))
    } else {
      passengers.value = []
    }
  },
  { immediate: true }
)

// ƒê·ªãnh nghƒ©a form validation v·ªõi vee-validate
const { errors, handleSubmit, defineField } = useForm({
  validationSchema: yup.object({
    passengers: yup.array().of(
      yup.object().shape({
        firstName: yup.string().required('B·∫Øt bu·ªôc nh·∫≠p h·ªç'),
        lastName: yup.string().required('Tr∆∞·ªùng t√™n ƒë·ªám v√† t√™n l√† b·∫Øt bu·ªôc'),
        titleName: yup.string().required('Tr∆∞·ªùng danh x∆∞ng l√† b·∫Øt bu·ªôc'),
        birthday: yup.string().required('Ng√†y sinh l√† b·∫Øt bu·ªôc')
      })
    ),
    email: yup.string().required('Email b·∫Øt bu·ªôc'),
    phone: yup.string().required('Phone b·∫Øt bu·ªôc').min(8)
  })
})

// ƒê·ªãnh nghƒ©a c√°c field trong form
const [email, emailAttrs] = defineField('email')
const [phone, phoneAttrs] = defineField('phone')

// H√†m ƒë·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu booking
const holdBooking = handleSubmit((values) => {
  console.log('üöÄ ~ holdBooking ~ values:', values)
  confirm.require({
    message: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c kh√¥ng?',
    header: 'X√°c nh·∫≠n',
    icon: 'pi pi-exclamation-triangle',
    rejectProps: { label: 'H·ªßy b·ªè', severity: 'secondary', outlined: true },
    acceptProps: { label: 'Save' },
    accept: async () => {
      toast.add({
        severity: 'info',
        summary: 'ƒêang c·∫≠p nh·∫≠t',
        detail: 'ƒêang ti·∫øn h√†nh c·∫≠p nh·∫≠t s√¢n bay...',
        life: 3000
      })

      const req = {
        bookingCode: genBookingCode(),
        createdAt: new Date().getTime(),
        flight: {
          id: information.value?.id,
          airline: information.value?.airline,
          departure: {
            time: information.value?.departure.time,
            airport: information.value?.departure.airport
          },
          arrival: {
            time: information.value?.arrival.time,
            airport: information.value?.arrival.airport
          },
          flightNumber: information.value?.flightNumber,
          aircraft: information.value?.aircraft,
          fareOptions: {
            class: price.value[0]?.class,
            price: price.value[0]?.total
          }
        },
        contact: {
          email: values.email,
          phone: values.phone
        },
        paxLists: passengers.value.map((passenger) => ({
          titleName: passenger.titleName,
          firstName: passenger.firstName,
          lastName: passenger.lastName,
          birthday: passenger.birthday
        }))
      }
      console.log({ passengers: values.passengers })
      console.log({ req })

      if (req) {
        reservationStore.holdBooking(req) // G·ªçi API
        router.push({ path: '/bookings' })
      } else {
        alert('ƒê·∫∑t Th·∫•t b·∫°i')
      }

      toast.add({
        severity: 'success',
        summary: 'Th√†nh c√¥ng',
        detail: 'ƒê·∫∑t v√© th√†nh c√¥ng!',
        life: 3000
      })
    },
    reject: () => {
      toast.add({
        severity: 'error',
        summary: 'L·ªói',
        detail: 'B·∫°n ƒë√£ t·ª´ ch·ªëi',
        life: 3000
      })
    }
  })
})

// H√†m ƒë·ªÉ quay l·∫°i trang booking
const backBooking = () => {
  router.push({ path: '/booking' })
}

// H√†m l·∫•y t√™n s√¢n bay t·ª´ code
const getAirportName = (code) => {
  const airport = planeStore.airports.find((airport) => airport.airportCode === code)
  return airport ? airport.name : code
}
onMounted(() => {
  planeStore.fetchAirports()

  const saveInformation = localStorage.getItem('flightTicket')
  const priceChair = localStorage.getItem('priceTicket')

  if (saveInformation && priceChair) {
    try {
      const parsedInfo = JSON.parse(saveInformation)
      const parsedPrice = JSON.parse(priceChair)

      if (typeof parsedInfo === 'object' && typeof parsedPrice === 'object') {
        information.value = parsedInfo
        price.value = parsedPrice
      } else {
        this.$toast.add({
          severity: 'warn',
          summary: 'L·ªói d·ªØ li·ªáu',
          detail: 'Th√¥ng tin ho·∫∑c gi√° v√© kh√¥ng h·ª£p l·ªá',
          life: 3000
        })
      }
    } catch (e) {
      this.$toast.add({
        severity: 'error',
        summary: 'L·ªói',
        detail: 'D·ªØ li·ªáu t·ª´ localStorage kh√¥ng h·ª£p l·ªá',
        life: 3000
      })
    }
  }
})
</script>
<style lang="css" scoped></style>
